---
title: "第一次作业解析"
author: "黄启岳"
date: "2021年4月27日"
output: 
  html_document: 
    theme: yeti #比较清楚的模板
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##1.数据可视化

###1.1 初步汇总数据，并简要描述小龙虾销售的基本情况，例如价格、销量情况。

```{r, warning = FALSE, message = FALSE}
library(readxl)
data <- read_xlsx("C:/Users/lenovo/Desktop/example-2/crawfish.xlsx")
summary(data)  #汇总数据
```

描述性统计一般重点关注数值型变量，summary()函数提供均值、最大最小值以及分位数。一般初步的描述性统计使用summary()即可，只是对数据的整体情况进行初步了解，研究开始阶段不必过于精细。

如果存在缺失值可能需要额外关注，并予以适当的处理，本次作业第二题中删去缺失数据即是一种较为“刚性”的处理办法。相对更“柔性”的处理则是通过补充数值代替NA，例如使用平均值或中位数替代、使用插值方法按照某种损失最小的原则进行插值等。

另一类需要格外注意的变量是哑变量即0-1变量，这些变量是分类变量的特例。分类变量为独立的事件，本身不具备数学结构，无法进行运算，但使用哑变量将其映射为$\mathbb{R}^{n}$上的数或向量就可以使用数学运算了。注意0-1变量均值具备一定的概率含义，结合概率含义可以进行一些解释。

###1.2 删除数据中没有提供人均价格(price)的店铺，并增加新的一列总销售额(total)为销量(sale)与人均价格(price)的乘积。

```{r, warning = FALSE, message = FALSE}
library(dplyr)
data1 <- dplyr::filter(data, price != "NA")%>% #改写成其他能够删去NA的条件语句亦可
  mutate(total = price*sale)
```

本题主要考察dplyr包的应用，对应数据分析中数据的清洗与生成环节，这个环节是衔接原始数据和建模的重要环节。

实际的数据分析中，数据很难处理干净，缺失值、记录错误等情况时有发生，这需要统计工作者们提前清理掉无效甚至错误的数据，否则这些异常的数据会污染模型，降低统计推断的预测效果。

针对第二问，也可以不用dplyr包，可以使用R语言自带的函数解决，例如：
```{r}
data2 <- subset(data, data$price!="NA")
total <- data2$price*data2$sale
data2 <- cbind(data2, total)     #效果相同，但需要多次存储
```

总而言之，dplyr不是唯一的选项，但是其是较好的选项。一般借助管道函数其性能较高，而且命令相对集成，输出“一步到位”，存储区的压力会减小很多。

###1.3 使用你认为合适的统计图表展示七座城市的总销售额(total)分布情况，解读你绘制的图表并推断可能的原因。

$\textbf{首先明确“分布情况”的含义。}$概率论中的“分布情况”一般指求解出分布函数或渐近分布，但在实际操作中很难获知精确的分布函数。这种情况下一般退而求其次，选择研究某个与分布$F$相关的统计量$T(F)$的分布情况进行代替，显然$T(F)$包含了分布函数的信息。例如$T(F)$为数学期望时，可以写作：
\begin{equation}
T(F)=\int_{\Omega}x\mathbf{d}F
\end{equation}

代入不同的$F$则$T(F)$会取到$\mathbb{R}^{n}$上不同的值，所以说$T(F)$包含了分布信息，观察$T(F)$的分布一定程度上可以了解原始分布$F$。

综上，只需要选择对total的统计量作图即可。常见的统计量为均值和分位数，其中分位数包含的信息更多，不仅包含参数中心位置的信息，还包含了参数的离散程度。本例中均值适合画柱状图，分位数更适合箱线图。

首先绘制均值的柱状图，然后绘制箱线图。

```{r}
library(ggplot2)
meantotal <- group_by(data1, city)%>%
  summarise( mean1 =mean(total))  #直接计算均值
ggplot(meantotal, aes(x = reorder(city,mean1,decreasing = F), y = mean1, fill = city))+geom_bar(stat = "identity",width = 0.5)+xlab("city")+ylab("mean of total")#升序排列
```
$$图1.升序排列的小龙虾销售额均值柱状图$$

不使用dplyr包中summarise()函数，使用stat_summary()也可，本例中使用reorder()即可排序。
```{r}
ggplot(data1, aes(x = reorder(city,total), y = total, fill = city, color = city))+stat_summary(fun = mean, geom = "bar", width = 0.5)+xlab("city")+ylab("mean of total")
```
$$图2.图1的等效画法$$

现绘制total分位数的箱线图，以箱宽代表样本量大小。由于箱线图涉及到的统计量较多，使用默认排序即可。
```{r}
ggplot(data1, aes(x = city, y = total, fill = city))+stat_boxplot(geom ="errorbar")+geom_boxplot(varwidth = T)+scale_y_continuous(trans = "log")+ylab("log(total)")
```
$$图3.分城市总销售额箱线图$$

个人认为均值的柱状图可以不取对数，因为均值本身已经平滑了原始数据中一部分的极端数据，消除了数据的部分“极性”，而且比较取对数作出的图对比更加明显且没有出现过度压缩图像的问题。但箱线图不取对数变换则箱会被压缩到底部，不方便观看。

至于柱状图是否需要标注数值即total的均值，个人建议是在不影响美观的情况下可以标注，如果数字太大(如本例中的total)以及小数点位数太多(如mean(total))可以不进行标注。

两种图互相比较，可以发现箱线图相比于柱状图不仅体现了分布中心位置的信息，还体现了分布离散程度的信息，甚至箱宽还携带了样本量维度的信息。因此箱线图可能更适合回答分布信息的问题。根据对数变换之后的箱线图可以看出total仍然呈现右偏，说明销售额total分布不均匀，所谓“二八定律”就是描述这类现象，即帕累托分布。这里给出密度函数：
\begin{equation}
\begin{aligned}
p(x)=\left\{\begin{array}
\text{0},x<x_{min}\\
\frac{kx^{k}_{min}}{x^{k+1}},x>x_{min}
\end{array}\right.
\end{aligned}
\end{equation}

这一步的目的是整体性研究关心的变量，即第二问中生成的total。此时因为不是细致研究，只是对新生成变量的总体分布情况进行研究，从宏观上掌握数据的情况。

###1.4 分别绘制合适的图表展现分城市有无wifi(wifi：有=1)、有无车位(park：有=1)以及不同折扣力度(distype)的总销售额(total)的平均值，判断这些因素的不同对总销售额(total)的平均值是否存在影响？陈述你的观点并适当分析原因。

1.4相比于1.3是对关心的变量的进一步研究，引入了一些控制变量，观察在不同控制变量下变量total的差异性。如果在某个条件下关心的因变量差异显著，在后续进一步建模中则需要考虑该因素对因变量的影响。这种手段在寻找自变量的过程中较为容易使用，一定程度上可以帮助寻找到合适的自变量，有助于模型构建。由于绘图类型与过程相似，这里仅以Wifi为例。

Wifi属于典型的0-1变量，可以用于分组，即每个城市分为有Wifi和没有两个种类。这里建议自变量选择为城市，因为同一座城市的相似店铺在类似甚至相同的环境下，销售额数值total具有可比性；如果以Wifi作为自变量不同城市营业额total在单纯控制有无Wifi的情况下可比性不是很强。

```{r}
WiFi <- factor(data1$wifi) #fill中填充因子，便于分类
ggplot(data1, aes(x = city, y = total, fill = WiFi))+stat_summary(geom = "bar", fun = mean, position = "dodge")+ylab("mean of total")  
```
$$图4.分城市有无WiFi销售额均值比较柱状图$$

这里建议使用并排的柱状图，因为柱状图起点相同，直接比较矩形的长度相对容易；堆叠图的起点不同，另外有的数据太小堆叠图有可能部分被堆叠的柱不太明显。

另一种方法是
```{r,warning = FALSE, message = FALSE}
data1 <- group_by(data1, city, wifi)%>%
  summarise(total_wifi = mean(total))
WiFi <- factor(data1$wifi)
ggplot(data1, aes(x = city, y = total_wifi, group = factor(wifi), fill = WiFi))+geom_bar(stat="identity",position="dodge")+ylab("mean of total")
```
$$图5.图4的等效做法$$

有的同学提到了不同类型店铺数量可能存在不同，会对结论造成影响。这里以折扣力度为例绘图探究。

```{r}
ggplot(data2, aes(x = city, fill = distype))+geom_bar(stat = "count", position = "dodge")
```
$$图6.分城市不同折扣店面数量柱状图$$
说明不同种类样本量存在差异，这需要被考虑。例如大部分同学都注意到武汉市六折以下店面平均销售额很高，但事实上这样的店很少，说明武汉市六折以下的店面平均销售额高有可能是行业内的巨头资金充足，需要抢夺市场甚至形成垄断产生了恶性竞争，俗称“内卷”，而这种“价格战”会迫使小的店面跟风降价，甚至以低于成本价的价格亏本销售，最终导致小型店面承受不起长期亏损而破产，存活下来的巨头获得了行业的定价权，从此人们将丧失“小龙虾自由”。这只是当前形势的一个缩影，具体内容不再展开，怕被查水表qaq\~懂的都懂\~

###1.5 王多鱼是一位投资人，他的资金规模相对不大，近期希望投资小龙虾餐饮业。根据以上的分析，你推荐他投资哪一座城市的小龙虾餐饮业？简单陈述理由。

可怜的王多鱼不再是西虹市首富，只是一个资金规模不大的投资人，这种情形下如何在资本搏杀中苟活下来才是重点。武汉市作为小龙虾主产地已经陷入深度内卷，不适合散户等小玩家；北上广深作为一线城市成本问题也比较大，竞争激烈是必然的；成都市则产业总体规模不大，箱线图的离群点说明垄断仍然存在。所以我觉得老王可以去长沙碰碰运气，要是看得准加盟某个巨头似乎也不错，而且重点是不要挣快钱，需要稳扎稳打，熬死对手你就赢了。

这道题目的目的主要是希望了解同学们在非优势情形下的竞争策略，不完全是考验同学们的统计学或编程功底。现实生活不是爽文，不能沉溺在某些人给的“精神鸦片”里，更不能幻想什么“战神回家，十万将士……”的故事，大部分时候都需要智慧、勇气和毅力战胜比自己更强的人，亦或是闯荡一片新天地。


#2.循环与函数
这道题目同学们整体完成情况较好，绝大部分同学都成功完成了对特定函数的梯度下降算法，并选择了部分变量封装函数。总体上同学们多选择起始点与学习率作为函数变量，函数本身也被作为变量，实现了对不同一阶导存在的函数求解梯度下降的过程。

这里提一个同学们很少考虑到的因素，即循环跳出的条件。只有少数同学在函数封装中将精度列为变量，并试图了解不同精度对循环的影响。其实可以考虑的问题是：如果学习率过小是否会导致循环提前跳出？这和迭代停止的条件有一定的关系，尤其到了高维的梯度下降法这个问题会很显著。有同学已经初步发现学习率太小会提前跳出循环，这里提示：观察循环跳出的条件与学习率的关系，甚至可以使用特定的尤其是容易计算导数的函数进行试验。

##总结
以上是对4月15日截止的第一次上机作业的简单分析，因为手疼qaq以及同学们完成得比较好所以梯度下降的程序没有写了，有问题的同学可以单独联系我\~\~
























